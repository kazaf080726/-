# ä¸‰æ˜Ÿ SM-A226B ä¸“å±žä¸€é”®ç¼–è¯‘è„šæœ¬ é›¶ä¸Šä¼  è¶…ç¨³å®‰å…¨ç‰ˆ
# é€‚é…æœºåž‹ï¼šGalaxy A22 5G SM-A226B MT6833V Android13 å†…æ ¸4.14.186
name: Build A226B Stable Kernel with KernelSU
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    permissions:
      contents: write
    defaults:
      run:
        shell: bash
        set -e

    steps:
      - name: ã€1/12ã€‘å‡†å¤‡ç¼–è¯‘çŽ¯å¢ƒ å®‰è£…æ‰€æœ‰ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y git build-essential bc bison flex libssl-dev libelf-dev zip curl python3 unzip wget
          echo "âœ… ç¼–è¯‘çŽ¯å¢ƒå®‰è£…å®Œæˆ"

      - name: ã€2/12ã€‘è‡ªåŠ¨æ‹‰å– SM-A226B å®˜æ–¹é€‚é…å†…æ ¸æºç 
        uses: actions/checkout@v4
        with:
          repository: EndlessFracture/android_kernel_samsung_a226b
          ref: main
          path: kernel

      - name: ã€æ ¡éªŒã€‘æ£€æŸ¥å†…æ ¸æºç å®Œæ•´æ€§
        run: |
          if [ ! -f ./kernel/Makefile ]; then
            echo "âŒ é”™è¯¯ï¼šæºç æ‹‰å–å¤±è´¥ï¼"
            exit 1
          fi
          echo "âœ… å†…æ ¸æºç å®Œæ•´æ€§æ ¡éªŒé€šè¿‡"

      - name: ã€3/12ã€‘ä¸‹è½½ä¸“å±žç¼–è¯‘å·¥å…·é“¾ Linaro GCC 7.5.0
        run: |
          wget -O gcc-linaro-7.5.0.tar.xz https://releases.linaro.org/components/toolchain/binaries/latest-7/aarch64-linux-gnu/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz
          tar -xf gcc-linaro-7.5.0.tar.xz
          echo "CC_PATH=$(pwd)/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin" >> $GITHUB_ENV
          echo "âœ… å·¥å…·é“¾ä¸‹è½½å®Œæˆ"

      - name: ã€4/12ã€‘è‡ªåŠ¨é›†æˆå®˜æ–¹KernelSU å½»åº•è§£å†³ç¬¦å·ç¼ºå¤±é—®é¢˜
        working-directory: ./kernel
        run: |
          curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh | bash -s main
          echo "âœ… KernelSUä»£ç æ³¨å…¥å®Œæˆ"

      - name: ã€æ ¡éªŒã€‘æ£€æŸ¥KernelSUæ³¨å…¥æ˜¯å¦æˆåŠŸ
        run: |
          if [ ! -d ./kernel/KernelSU ]; then
            echo "âŒ é”™è¯¯ï¼šKernelSUæ³¨å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥ï¼"
            exit 1
          fi
          echo "âœ… KernelSUæ³¨å…¥æ ¡éªŒé€šè¿‡"

      - name: ã€5/12ã€‘åŠ è½½SM-A226Bä¸“å±žæœºåž‹é…ç½®
        working-directory: ./kernel
        run: |
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export PATH=$CC_PATH:$PATH
          make a226b_defconfig
          echo "âœ… æœºåž‹é…ç½®åŠ è½½å®Œæˆ"

      - name: ã€æ ¡éªŒã€‘æ£€æŸ¥æœºåž‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆ
        run: |
          if [ ! -f ./kernel/.config ]; then
            echo "âŒ é”™è¯¯ï¼šæœºåž‹é…ç½®åŠ è½½å¤±è´¥ï¼"
            exit 1
          fi
          echo "âœ… æœºåž‹é…ç½®æ ¡éªŒé€šè¿‡"

      - name: ã€6/12ã€‘å¼€å¯KernelSUå†…ç½®ç¨³å®šæ¨¡å¼
        working-directory: ./kernel
        run: |
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export PATH=$CC_PATH:$PATH
          scripts/config --file .config --enable CONFIG_KSU
          scripts/config --file .config --disable CONFIG_KSU_DEBUG
          echo "âœ… KernelSUå†…ç½®æ¨¡å¼å¼€å¯å®Œæˆ"

      - name: ã€7/12ã€‘ç¼–è¯‘å†…æ ¸ å…¨æ ¸å¿ƒå¹¶è¡ŒåŠ é€Ÿ
        working-directory: ./kernel
        run: |
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export PATH=$CC_PATH:$PATH
          make -j$(nproc) Image.gz-dtb
          echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ"

      - name: ã€æ ¡éªŒã€‘æ£€æŸ¥å†…æ ¸ç¼–è¯‘äº§ç‰©
        run: |
          if [ ! -f ./kernel/arch/arm64/boot/Image.gz-dtb ]; then
            echo "âŒ é”™è¯¯ï¼šå†…æ ¸ç¼–è¯‘å¤±è´¥ï¼Œæ²¡æœ‰ç”Ÿæˆé•œåƒæ–‡ä»¶ï¼"
            exit 1
          fi
          echo "âœ… å†…æ ¸ç¼–è¯‘äº§ç‰©æ ¡éªŒé€šè¿‡"

      - name: ã€8/12ã€‘æ‹‰å–å®˜æ–¹AnyKernel3 æ‰“åŒ…TWRPå¯åˆ·åŒ…
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git
          cp ./kernel/arch/arm64/boot/Image.gz-dtb AnyKernel3/
          echo "âœ… AnyKernel3æ‹‰å–å®Œæˆ"

      - name: ã€9/12ã€‘å†™å…¥SM-A226Bä¸“å±žé˜²åˆ·é”™é…ç½®
        run: |
          cat > AnyKernel3/anykernel.sh << 'EOF'
# AnyKernel3 ä¸“å±žé…ç½® SM-A226B å®‰å…¨é˜²åˆ·é”™ç‰ˆ
do.devicecheck=1
do.modules=0
do.systemless=1
do.cleanup=1
do.cleanuponabort=0
device.name1=SM-A226B
device.name2=a22x
device.name3=Galaxy A22 5G
supported.versions=13
supported.patchlevels=*

block=/dev/block/by-name/boot
is_slot_device=0
ramdisk_compression=auto
patch_vbmeta_flag=auto

split_boot;
flash_boot;
EOF
          echo "âœ… ä¸“å±žåˆ·å…¥é…ç½®å†™å…¥å®Œæˆ"

      - name: ã€10/12ã€‘æ‰“åŒ…TWRPå¯åˆ·å…¥ZIPåŒ…
        run: |
          cd AnyKernel3
          zip -r A226B-KernelSU-Stable-$(date +%Y%m%d).zip *
          cd ..
          mkdir -p output
          cp ./kernel/arch/arm64/boot/Image.gz-dtb output/
          cp AnyKernel3/A226B-KernelSU-Stable-*.zip output/
          echo "âœ… åˆ·å…¥åŒ…æ‰“åŒ…å®Œæˆ"

      - name: ã€11/12ã€‘ä¸Šä¼ ç¼–è¯‘äº§ç‰© ç›´æŽ¥ä¸‹è½½å°±èƒ½ç”¨
        uses: actions/upload-artifact@v4
        with:
          name: A226B-KernelSU-Stable-Output
          path: output/
          retention-days: 30

      - name: ã€12/12ã€‘ç¼–è¯‘å®Œæˆ å®‰å…¨æç¤º
        run: |
          echo "ðŸŽ‰ æ­å–œï¼SM-A226B ä¸“å±žå†…æ ¸ç¼–è¯‘å…¨éƒ¨å®Œæˆï¼"
          echo "âš ï¸  åˆ·å…¥å‰åŠ¡å¿…åœ¨TWRPå¤‡ä»½åŽŸåŽ‚bootåˆ†åŒºï¼"
          echo "âš ï¸  æ•‘ç –å…œåº•ï¼šåˆ·é”™æ— é™é‡å¯ï¼Œç›´æŽ¥è¿›Downloadæ¨¡å¼ç”¨Odinåˆ·å›žåŽŸåŽ‚boot"
